<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#111; color:#fff; }
    header { background:#000; padding:15px 30px; font-size:20px; font-weight:bold; display:flex; justify-content:space-between; }
    .container { display:flex; justify-content:space-around; margin:40px; gap:30px; flex-wrap:wrap; }
    .card { background:#1e1e1e; border-radius:10px; padding:20px; width:min(560px, 100%); box-shadow:0 0 10px rgba(0,0,0,.5); }
    .card h2 { margin:0 0 12px; }
    .feed-container { position: relative; width:100%; border-radius:10px; overflow: hidden; }
    .feed img { width:100%; border-radius:10px; display:block; transition: opacity 0.3s; }
    .feed-placeholder { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      display: flex; align-items: center; justify-content: center; 
      background: #2a2a2a; color: #888; border-radius:10px;
    }
    .alert-box { background:#c62828; padding:15px; border-radius:8px; font-weight:bold; margin-bottom:15px; white-space:pre-line; }
    .map { background:#333; height:200px; display:flex; align-items:center; justify-content:center; border-radius:10px; }
    .button-container { text-align:center; margin:20px 40px 60px; }
    .button { background:#333; border:none; color:#fff; padding:15px 40px; font-size:16px; border-radius:5px; cursor:pointer; }
    .button:hover { background:#444; }
    .status-bar { 
      display: flex; justify-content: space-between; 
      margin-top: 10px; font-size: 14px; color: #aaa;
    }
    .last-updated { font-style: italic; }
    .loading-spinner {
      width: 40px; height: 40px; border: 4px solid #333; 
      border-top: 4px solid #009900; border-radius: 50%; 
      animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div>DASHBOARD</div>
    <div id="connectionStatus">CONNECTED</div>
  </header>

  <div class="container">
    <!-- Feed Card -->
    <div class="card feed">
      <h2>Drone Feed</h2>
      <div class="feed-container">
        <div id="feedPlaceholder" class="feed-placeholder">
          <div>Loading drone feed...</div>
        </div>
        <img id="feedImg" alt="Drone Feed Image" style="display:none;">
      </div>
      <div class="status-bar">
        <span class="last-updated" id="lastUpdated">Last updated: --:--:--</span>
        <span id="imageStatus">Waiting for image...</span>
      </div>
    </div>

    <!-- Alerts Card -->
    <div class="card alerts">
      <h2>Detection Alerts</h2>
      <div class="alert-box" id="coordsBox">Loading detection data...</div>
      <div class="map">
        <div id="mapPlaceholder">üìç Map Preview</div>
      </div>
      <div class="status-bar">
        <span class="last-updated" id="coordsUpdated">Last updated: --:--:--</span>
        <span id="coordsStatus">Waiting for data...</span>
      </div>
    </div>
  </div>

  <div class="button-container">
    <a href="database.txt" download>
      <button class="button">DOWNLOAD LOG</button>
    </a>
    <button class="button" onclick="refreshAll()" style="margin-left: 15px;">MANUAL REFRESH</button>
  </div>

<script>
  // DOM elements
  const feedImg = document.getElementById('feedImg');
  const feedPlaceholder = document.getElementById('feedPlaceholder');
  const coordsBox = document.getElementById('coordsBox');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const coordsUpdatedEl = document.getElementById('coordsUpdated');
  const imageStatusEl = document.getElementById('imageStatus');
  const coordsStatusEl = document.getElementById('coordsStatus');
  const connectionStatusEl = document.getElementById('connectionStatus');

  // Function to update timestamp
  function updateTimestamp(element) {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    element.textContent = `Last updated: ${timeString}`;
  }

  // ---- image loading with error handling ----
  function refreshFeed() {
    // Show loading state
    feedPlaceholder.style.display = 'flex';
    feedImg.style.display = 'none';
    imageStatusEl.textContent = 'Loading...';
    
    // Create a new image object to test loading
    const testImage = new Image();
    const cacheBuster = '?nocache=' + Date.now();
    
    testImage.onload = function() {
      // If image loads successfully, set it as the source
      feedImg.src = testImage.src;
      feedImg.style.display = 'block';
      feedPlaceholder.style.display = 'none';
      updateTimestamp(lastUpdatedEl);
      imageStatusEl.textContent = 'Image loaded successfully';
      connectionStatusEl.textContent = 'CONNECTED';
      connectionStatusEl.style.color = '#4CAF50';
    };
    
    testImage.onerror = function() {
      // If image fails to load, show placeholder
      feedPlaceholder.innerHTML = '<div>Error loading image<br><small>Using placeholder</small></div>';
      feedImg.style.display = 'none';
      updateTimestamp(lastUpdatedEl);
      imageStatusEl.textContent = 'Error loading image';
      connectionStatusEl.textContent = 'CONNECTION ISSUE';
      connectionStatusEl.style.color = '#F44336';
      
      // You can set a placeholder image here if you have one
      // feedImg.src = 'placeholder.jpg';
    };
    
    // Try to load the image
    testImage.src = 'test.jpg' + cacheBuster;
  }

  // ---- load detection text (coords.txt) ----
  async function loadCoords() {
    try {
      coordsStatusEl.textContent = 'Loading...';
      const res = await fetch('coords.txt', { cache: 'no-store' });
      
      if (!res.ok) throw new Error(`Server returned ${res.status}: ${res.statusText}`);
      
      const text = (await res.text()).trim();
      coordsBox.textContent = text || 'No detections found';
      coordsBox.style.background = text ? '#c62828' : '#2E7D32';
      updateTimestamp(coordsUpdatedEl);
      coordsStatusEl.textContent = text ? 'Detection data loaded' : 'No detections';
      
    } catch (error) {
      coordsBox.textContent = 'Error loading detection data: ' + error.message;
      coordsBox.style.background = '#FF9800';
      updateTimestamp(coordsUpdatedEl);
      coordsStatusEl.textContent = 'Error loading data';
    }
  }

  // Refresh all data
  function refreshAll() {
    refreshFeed();
    loadCoords();
  }

  // Initialize and set intervals
  refreshAll();
  setInterval(refreshFeed, 15000); // refresh image every 15s
  setInterval(loadCoords, 5000);   // refresh coords every 5s
</script>

</body>
</html>
