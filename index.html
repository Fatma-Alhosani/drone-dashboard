<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Drone Surveillance Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#0f0f10; --card:#1a1b1e; --sub:#141518; --accent:#4CAF50; --muted:#a7a7a7; --danger:#c93a3a; --border:#2a2b2f;
  }
  body{margin:0;background:var(--bg);color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#000;border-bottom:1px solid var(--border)}
  header .status{font-size:12px;color:#9fe79f}
  .wrap{padding:18px;display:flex;justify-content:center}
  .grid{width:min(1200px,100%);display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  .pane{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .pane h3{margin:0;padding:10px 12px;background:var(--sub);border-bottom:1px solid var(--border);font-size:13px;letter-spacing:.3px;color:#ddd}
  .meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);padding:8px 12px;border-top:1px solid var(--border);background:var(--sub)}
  .controls{display:flex;gap:10px;justify-content:center;padding:12px;background:var(--sub);border-top:1px solid var(--border)}
  button{border:1px solid var(--border);background:#232427;color:#fff;padding:9px 14px;border-radius:8px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .btn{background:#2a2b31}
  .btn.primary{background:var(--accent);border-color:#3a8f43}
  .btn.danger{background:var(--danger);border-color:#942b2b}
  .counter{font-size:12px;color:var(--muted)}
  .feed{height:360px;display:flex;align-items:center;justify-content:center;background:#0f1012}
  #photo{max-width:100%;max-height:100%;object-fit:contain}
  #map{height:360px}
</style>
</head>
<body>
<header>
  <div>üõ∞Ô∏è DRONE SURVEILLANCE DASHBOARD</div>
  <div class="status">GitHub Pages ¬∑ static</div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Images -->
    <div class="pane">
      <h3 id="imgTitle">Images</h3>
      <div class="feed"><img id="photo" alt="No image"/></div>
      <div class="meta">
        <span id="dateMeta">Date: ‚Äî</span>
        <span id="timeMeta">Time: ‚Äî</span>
        <span class="counter" id="pairMeta">Pair 0 of 0</span>
      </div>
      <div class="controls">
        <button class="btn" id="prevBtn">Previous</button>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="nextBtn">Next</button>
        <button class="btn danger" id="discardBtn">Discard</button>
      </div>
    </div>

    <!-- GPS -->
    <div class="pane">
      <h3>GPS Coordinates</h3>
      <div id="map"></div>
      <div class="meta">
        <span id="gpsCount">0 items</span>
        <span id="gpsCoord" style="margin-left:auto">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =========================
   Strict photo‚ÄìGPS pairing
   ========================= */

/* Expected JSON:
   photos.json -> [{name:"2025-10-15_13-13-09.jpg", url:"photos/2025-10-15_13-13-09.jpg"}, ...]
   gps.json    -> [{name:"2025-10-15_13-13-09.txt", lat:25.31311, lng:55.49100}, ...]
*/

let pairs = [];     // [{key, photoName, photoUrl, lat, lng}]
let idx = 0;
let discarded = new Set(JSON.parse(localStorage.getItem("discarded_keys") || "[]"));

const imgTitle = document.getElementById("imgTitle");
const photoEl  = document.getElementById("photo");
const dateEl   = document.getElementById("dateMeta");
const timeEl   = document.getElementById("timeMeta");
const pairEl   = document.getElementById("pairMeta");
const gpsCount = document.getElementById("gpsCount");
const gpsCoord = document.getElementById("gpsCoord");

const map = L.map("map").setView([25.3131, 55.4910], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let marker = L.marker([25.3131, 55.4910]).addTo(map);

function baseNoExt(name){
  const b = name.replace(/^.*\//,"");
  const dot = b.lastIndexOf(".");
  return dot>0 ? b.slice(0,dot) : b;
}

function parseDateTimeFromKey(key){
  // supports 2025-10-15_13-13-09 or 2025-10-15|13-13-09
  const date = key.slice(0,10);
  const time = key.slice(-8).replaceAll("-",":");
  return {date, time};
}

async function loadAll(){
  const [photos, gps] = await Promise.all([
    fetch("photos.json").then(r=>r.json()),
    fetch("gps.json").then(r=>r.json())
  ]);

  // Build dictionaries keyed by basename
  const P = new Map(); // key -> {photoName, url}
  for (const p of photos){
    P.set(baseNoExt(p.name), {photoName:p.name, url:p.url});
  }
  const G = new Map(); // key -> {lat,lng}
  for (const g of gps){
    G.set(baseNoExt(g.name), {lat:g.lat, lng:g.lng});
  }

  // Intersect keys (only items that exist in BOTH)
  const keys = [];
  for (const k of P.keys()){
    if (G.has(k)) keys.push(k);
  }
  keys.sort(); // chronological if names are timestamps

  // Build pairs and filter discards
  pairs = keys
    .filter(k => !discarded.has(k))
    .map(k => ({
      key: k,
      photoName: P.get(k).photoName,
      photoUrl:  P.get(k).url,
      lat: G.get(k).lat,
      lng: G.get(k).lng
    }));

  idx = Math.min(idx, Math.max(pairs.length-1, 0));
  render();
}

function render(){
  const total = pairs.length;
  if (total === 0){
    imgTitle.textContent = "Images";
    photoEl.src = "";
    photoEl.alt = "No images available";
    dateEl.textContent = "Date: ‚Äî";
    timeEl.textContent = "Time: ‚Äî";
    pairEl.textContent = "Pair 0 of 0";
    gpsCount.textContent = "0 items";
    gpsCoord.textContent = "‚Äî";
    marker.setLatLng([25.3131,55.4910]);
    map.setView([25.3131,55.4910], 15);
    return;
  }
  const cur = pairs[idx];
  imgTitle.textContent = cur.photoName;
  photoEl.src = cur.photoUrl;
  photoEl.alt = cur.photoName;

  const {date,time} = parseDateTimeFromKey(cur.key);
  dateEl.textContent = "Date: " + date;
  timeEl.textContent = "Time: " + time;
  pairEl.textContent = `Pair ${idx+1} of ${total}`;

  gpsCount.textContent = `${total} items`; // pairs count reflects synced items only
  gpsCoord.textContent = `${cur.lat.toFixed(6)}, ${cur.lng.toFixed(6)}`;
  marker.setLatLng([cur.lat,cur.lng]);
  map.setView([cur.lat,cur.lng], 17);
}

/* Controls */
document.getElementById("nextBtn").onclick = ()=>{
  if (!pairs.length) return;
  idx = (idx+1) % pairs.length;
  render();
};
document.getElementById("prevBtn").onclick = ()=>{
  if (!pairs.length) return;
  idx = (idx-1+pairs.length) % pairs.length;
  render();
};
document.getElementById("refreshBtn").onclick = ()=>{
  loadAll().catch(console.error);
};
document.getElementById("discardBtn").onclick = ()=>{
  if (!pairs.length) return;
  const key = pairs[idx].key;

  discarded.add(key);
  localStorage.setItem("discarded_keys", JSON.stringify([...discarded]));

  pairs.splice(idx,1);
  if (idx >= pairs.length) idx = 0;
  render();
};

// keyboard arrows
window.addEventListener("keydown",(e)=>{
  if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
  if (e.key === "ArrowLeft")  document.getElementById("prevBtn").click();
});

/* Boot */
loadAll().catch(console.error);
</script>
</body>
</html>
