<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Drone Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#111; --card:#1e1e1e; --sub:#151515; --accent:#4CAF50; --muted:#aaa; --border:#333; --error:#c62828;
    }
    body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:#fff;overflow-x:hidden;}
    header{background:#000;padding:15px 30px;font-size:20px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.5);}
    .header-status{font-size:14px;color:var(--accent);display:flex;align-items:center;}
    .status-dot{width:10px;height:10px;background:var(--accent);border-radius:50%;margin-right:8px;}

    /* --- One big card --- */
    .wrap{padding:28px;display:flex;justify-content:center;}
    .violations{
      width:min(1200px,100%);
      background:var(--card);
      border-radius:14px;
      padding:18px 18px 10px;
      box-shadow:0 0 18px rgba(0,0,0,.35);
    }
    .violations h2{
      margin:0 0 14px 0; font-size:22px; color:var(--accent);
      padding-bottom:10px; border-bottom:1px solid var(--border);
    }

    /* two-column content inside the card */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .pane{
      background:var(--sub);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px;
      min-height:360px;
    }
    .pane h3{
      margin:0 0 10px 0; font-size:14px; text-transform:uppercase; letter-spacing:.6px; color:#ddd;
      display:flex; justify-content:space-between; align-items:center;
    }
    .tiny{ font-size:12px; color:var(--muted); background:#2b2b2b; padding:4px 8px; border-radius:6px; }

    /* image side */
    .feed-container{position:relative;width:100%;height:360px;border-radius:10px;overflow:hidden;background:#101010;}
    .feed-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#2a2a2a;color:#bbb;flex-direction:column;text-align:center;padding:10px;gap:8px;}
    #feedImg{width:100%;height:100%;object-fit:contain;border-radius:10px;display:none;transition:opacity .25s ease;}

    /* map side */
    #map{height:260px;border-radius:10px;margin-top:6px;z-index:1;}
    .coordinates-list{max-height:152px;overflow-y:auto;background:#1c1c1c;padding:8px;border-radius:8px;margin-top:10px;font-family:monospace;border:1px solid var(--border);}
    .coordinates-list div{padding:5px;border-bottom:1px solid #2f2f2f;}
    .coordinates-list div:last-child{border-bottom:none;}
    .active-coordinate{background:#272727;font-weight:bold;}

    /* unified controls */
    .controls{
      display:flex; align-items:center; justify-content:center; gap:10px;
      margin:16px 6px 6px;
    }
    .control-btn{
      background:#333;color:#fff;border:1px solid #444;padding:10px 18px;border-radius:8px;cursor:pointer;transition:background .2s ease;
    }
    .control-btn:hover{ background:#3d3d3d; }
    .counter{font-size:13px;color:var(--muted);padding:6px 10px;background:#232323;border:1px solid #3a3a3a;border-radius:8px;}

    /* toast (kept) */
    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
      background:#222; color:#fff; border:1px solid #444; border-radius:10px;
      padding:12px 16px; box-shadow:0 6px 20px rgba(0,0,0,.45); display:flex; align-items:center; gap:10px;
      opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:1000;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto; }
    .toast .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); }
    .toast .actions{ margin-left:8px; display:flex; gap:8px; }
    .toast button{ background:#333; color:#fff; border:1px solid #555; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .toast button:hover{ background:#3a3a3a; }
  </style>
</head>
<body>
<header>
  <div>DRONE SURVEILLANCE DASHBOARD</div>
  <div class="header-status">
    <div class="status-dot"></div>
    <span id="connectionStatus">OPERATIONAL</span>
  </div>
</header>

<div class="wrap">
  <section class="violations">
    <h2>Probable Violations</h2>

    <div class="grid">
      <!-- LEFT: Images -->
      <div class="pane">
        <h3>
          Captured Frames
          <span class="tiny" id="filenameDisplay">Loading…</span>
        </h3>
        <div class="feed-container">
          <div id="feedPlaceholder" class="feed-placeholder">Loading images from GitHub…</div>
          <img id="feedImg" alt="Drone Frame">
        </div>
      </div>

      <!-- RIGHT: GPS -->
      <div class="pane">
        <h3>
          GPS / Map
          <span class="tiny" id="gpsFilename">--</span>
        </h3>

        <div style="background:#8b1f1f;padding:10px 12px;border-radius:8px;margin-bottom:8px;border:1px solid #a22;">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;font-weight:bold;">
            <span>Current GPS Location</span>
            <span id="currentCoord">--, --</span>
          </div>
          <div style="opacity:.9;font-size:12px" id="currentTime">timestamp: --</div>
        </div>

        <div id="map"></div>

        <h4 style="margin:12px 4px 6px">GPS Coordinates from File</h4>
        <div class="coordinates-list" id="coordinatesList"></div>
      </div>
    </div>

    <!-- ONE unified control bar -->
    <div class="controls">
      <button class="control-btn" id="prevBtn">Previous</button>
      <span class="counter" id="pairCounter">Pair 0 of 0</span>
      <button class="control-btn" id="nextBtn">Next</button>
    </div>
  </section>
</div>

<!-- Toast -->
<div id="newImageToast" class="toast" role="status" aria-live="polite">
  <span class="dot"></span>
  <span id="toastMsg">New image received</span>
  <div class="actions">
    <button id="toastViewBtn" title="Open newest image">View</button>
    <button id="toastDismissBtn" title="Dismiss">Dismiss</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  // ---------- DOM refs ----------
  const feedImg = document.getElementById('feedImg');
  const feedPlaceholder = document.getElementById('feedPlaceholder');
  const filenameDisplayEl = document.getElementById('filenameDisplay');
  const pairCounterEl = document.getElementById('pairCounter');
  const connectionStatusEl = document.getElementById('connectionStatus');
  const statusDot = document.querySelector('.status-dot');

  const coordinatesListEl = document.getElementById('coordinatesList');
  const currentCoordEl = document.getElementById('currentCoord');
  const currentTimeEl = document.getElementById('currentTime');
  const gpsFilenameEl = document.getElementById('gpsFilename');

  const toast = document.getElementById('newImageToast');
  const toastMsg = document.getElementById('toastMsg');
  const toastViewBtn = document.getElementById('toastViewBtn');
  const toastDismissBtn = document.getElementById('toastDismissBtn');

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // ---------- Config ----------
  const githubRepo = "Fatma-Alhosani/drone-dashboard";
  const photosPath = "photos";
  const gpsPath = "GPS";
  // window.GITHUB_TOKEN = "ghp_xxx"; // optional

  // ---------- State ----------
  // Each pair: { key, ts, photo:{name,url}, gps:{name,url} }
  let pairs = [];
  let currentPairIndex = 0;

  let gpsCoordinates = [];   // parsed from current CSV
  let currentCoordIndex = 0;

  let lastSeenTimestamp = null; // newest pair's ts (ms)

  // ---------- Map ----------
  const map = L.map('map').setView([37.7749,-122.4194],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
  const marker = L.marker([37.7749,-122.4194]).addTo(map);

  // ---------- Helpers ----------
  function ghHeaders(){
    const h = { 'Accept': 'application/vnd.github+json' };
    if (window.GITHUB_TOKEN) h['Authorization'] = 'Bearer ' + window.GITHUB_TOKEN;
    return h;
  }
  async function ghListFolder(path){
    const url = `https://api.github.com/repos/${githubRepo}/contents/${path}`;
    const res = await fetch(url, { headers: ghHeaders() });
    if(!res.ok) throw new Error(`GitHub error ${res.status} for ${path}`);
    return res.json();
  }
  function baseName(name){
    const i = name.lastIndexOf('.');
    return i > 0 ? name.slice(0,i) : name;
  }
  function tsFromName(name){
    // Accept YYYY-MM-DD_[HH]-[MM]-[SS] OR YYYY-MM-DD|HH-MM-SS
    const m = name.match(/^(\d{4})-(\d{2})-(\d{2})[|_](\d{2})-(\d{2})-(\d{2})/);
    if(!m) return null;
    const [ , Y,M,D,h,min,s ] = m.map(Number);
    return Date.UTC(Y, M-1, D, h, min, s);
  }
  function showToast(message, onView){
    toastMsg.textContent = message;
    toast.classList.add('show');
    const hide = ()=> toast.classList.remove('show');
    toastDismissBtn.onclick = hide;
    toastViewBtn.onclick = ()=>{ hide(); onView?.(); };
    setTimeout(hide, 6000);
  }

  // ---------- Load & Build PAIRS ----------
  async function loadAllPairs(){
    feedPlaceholder.style.display='flex';
    feedPlaceholder.textContent='Loading from GitHub…';
    feedImg.style.display='none';

    const [photosList, gpsList] = await Promise.all([ ghListFolder(photosPath), ghListFolder(gpsPath) ]);

    const photos = photosList
      .filter(i=>i.type==='file' && /\.(jpe?g|png|webp|bmp|gif)$/i.test(i.name))
      .map(i=>({ name:i.name, url:i.download_url, key: baseName(i.name), ts: tsFromName(i.name) }));

    const gpsFiles = gpsList
      .filter(i=>i.type==='file' && /\.csv$/i.test(i.name))
      .map(i=>({ name:i.name, url:i.download_url, key: baseName(i.name), ts: tsFromName(i.name) }));

    const gpsByKey = new Map(gpsFiles.map(g => [g.key, g]));
    const combined = photos.filter(p => gpsByKey.has(p.key))
      .map(p => ({ key: p.key, ts: p.ts, photo:{name:p.name,url:p.url}, gps:gpsByKey.get(p.key) }));

    if (!combined.length) throw new Error("No matched image+GPS pairs found");

    combined.sort((a,b)=>{
      if(a.ts!=null && b.ts!=null) return a.ts - b.ts;
      if(a.ts!=null) return 1;
      if(b.ts!=null) return -1;
      return a.key.localeCompare(b.key, undefined, {numeric:true, sensitivity:'base'});
    });

    pairs = combined;
    currentPairIndex = pairs.length - 1; // newest
    const newest = pairs[pairs.length-1];
    lastSeenTimestamp = newest.ts ?? Date.now();

    await showPair(currentPairIndex);
    updateCounter();
  }

  function updateCounter(){
    pairCounterEl.textContent = `Pair ${pairs.length ? currentPairIndex+1 : 0} of ${pairs.length}`;
  }

  // ---------- Poll for new pairs ----------
  async function checkForNewPairs(){
    try{
      const list = await ghListFolder(photosPath);
      const imgs = list
        .filter(i=>i.type==='file' && /\.(jpe?g|png|webp|bmp|gif)$/i.test(i.name))
        .map(i=>({ name:i.name, ts: tsFromName(i.name) }))
        .sort((a,b)=>{
          if(a.ts!=null && b.ts!=null) return a.ts - b.ts;
          if(a.ts!=null) return 1;
          if(b.ts!=null) return -1;
          return a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'});
        });

      if(!imgs.length) return;
      const newestImg = imgs[imgs.length-1];
      const newestTs = newestImg.ts ?? Date.now();

      if (lastSeenTimestamp == null || newestTs > lastSeenTimestamp) {
        await loadAllPairs();
        const newestPair = pairs[pairs.length-1];
        lastSeenTimestamp = newestPair.ts ?? Date.now();
        showToast(`New pair received: ${newestPair.photo.name}`, async () => {
          currentPairIndex = pairs.length - 1;
          await showPair(currentPairIndex);
          updateCounter();
        });
      }
    }catch(e){ /* ignore */ }
  }

  // ---------- Show one PAIR ----------
  async function showPair(i){
    if (i < 0 || i >= pairs.length) return;
    const pair = pairs[i];
    await loadImage(pair.photo);
    await loadGPSFromUrl(pair.gps.url, pair.gps.name);
    updateCounter();
  }

  // unified navigation
  async function nextPair(){
    if (currentPairIndex < pairs.length - 1) {
      currentPairIndex++;
      await showPair(currentPairIndex);
    }
  }
  async function prevPair(){
    if (currentPairIndex > 0) {
      currentPairIndex--;
      await showPair(currentPairIndex);
    }
  }

  // ---------- Image loader ----------
  async function loadImage(info){
    feedPlaceholder.style.display='flex';
    feedPlaceholder.textContent='Loading image…';
    feedImg.style.display='none';
    return new Promise((resolve)=>{
      const img = new Image();
      const cache='?nocache='+Date.now();
      img.onload=()=>{
        feedImg.src=info.url+cache;
        feedImg.style.display='block';
        feedPlaceholder.style.display='none';
        filenameDisplayEl.textContent=info.name;
        connectionStatusEl.textContent='OPERATIONAL';
        statusDot.style.background='#4CAF50';
        resolve();
      };
      img.onerror=()=>{
        feedPlaceholder.innerHTML=`<div>⚠️ Failed to load ${info.name}</div>`;
        feedImg.style.display='none';
        filenameDisplayEl.textContent='Image error';
        connectionStatusEl.textContent='CONNECTION ISSUE';
        statusDot.style.background='#F44336';
        resolve();
      };
      img.src=info.url+cache;
    });
  }

  // ---------- GPS CSV loader ----------
  async function loadGPSFromUrl(url, uiName){
    try{
      const res = await fetch(url + '?nocache=' + Date.now());
      if(!res.ok) throw new Error(`CSV download failed ${res.status}`);
      const csvText = await res.text();

      const lines = csvText.split(/\r?\n/).filter(l => l.trim().length>0);
      if (lines.length < 2) throw new Error('CSV has no data rows');

      const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const idxTime = header.findIndex(h => /time/.test(h));
      const idxLat  = header.findIndex(h => /^lat$/.test(h) || /latitude/.test(h));
      const idxLon  = header.findIndex(h => /^lon$/.test(h) || /^lng$/.test(h) || /longitude/.test(h));
      const idxAlt  = header.findIndex(h => /alt/.test(h));

      if (idxLat === -1 || idxLon === -1) throw new Error('CSV missing lat/lon');

      gpsCoordinates = lines.slice(1).map(row=>{
        const cols = row.split(',').map(c=>c.trim());
        const ts  = idxTime >= 0 ? cols[idxTime] : null;
        const lat = parseFloat(cols[idxLat]);
        const lng = parseFloat(cols[idxLon]);
        const alt = idxAlt >= 0 ? parseFloat(cols[idxAlt]) : null;
        return { ts, lat, lng, alt };
      }).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));

      gpsFilenameEl.textContent = uiName;

      // use newest row
      currentCoordIndex = gpsCoordinates.length - 1;
      renderCoordList();
      updateMapMarker(currentCoordIndex);

    }catch(err){
      gpsFilenameEl.textContent = 'GPS error';
      currentCoordEl.textContent = '--, --';
      currentTimeEl.textContent = 'timestamp: --';
      console.error('GPS load error:', err);
    }
  }

  function renderCoordList(){
    coordinatesListEl.innerHTML='';
    gpsCoordinates.forEach((c,i)=>{
      const el=document.createElement('div');
      const ts = c.ts ? ` [${c.ts}]` : '';
      el.textContent=`${c.lat.toFixed(4)}, ${c.lng.toFixed(4)}${ts}`;
      if(i===currentCoordIndex) el.classList.add('active-coordinate');
      coordinatesListEl.appendChild(el);
    });
    const active = coordinatesListEl.children[currentCoordIndex];
    if (active) active.scrollIntoView({behavior:'smooth', block:'nearest'});
  }
  function updateMapMarker(i){
    if(!gpsCoordinates.length) return;
    const c=gpsCoordinates[i];
    map.setView([c.lat,c.lng],15);
    marker.setLatLng([c.lat,c.lng]);
    currentCoordEl.textContent=`${c.lat.toFixed(4)}, ${c.lng.toFixed(4)}`;
    currentTimeEl.textContent = `timestamp: ${c.ts ?? '--'}`;
  }

  // ---------- Init ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    prevBtn.addEventListener('click', prevPair);
    nextBtn.addEventListener('click', nextPair);
    toastDismissBtn.addEventListener('click',()=>toast.classList.remove('show'));
    toastViewBtn.addEventListener('click',async ()=>{ toast.classList.remove('show'); currentPairIndex=pairs.length-1; await showPair(currentPairIndex); });

    await loadAllPairs();
    setInterval(checkForNewPairs, 30000);
  });
</script>
</body>
</html>
