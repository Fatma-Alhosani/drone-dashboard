<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Drone surveillance dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<style>
:root{ --bg:#121212; --card:#1e1e1e; --sub:#151515; --accent:#4CAF50; --muted:#9aa; --border:#333; --danger:#b43; --chip:#2b2b2b; }
body.light{ --bg:#f7f7f7; --card:#fff; --sub:#f0f0f0; --accent:#0066cc; --muted:#555; --border:#ccc; --danger:#c33; --chip:#e8e8e8; color:#000; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Arial,sans-serif;}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#000;}
.status{display:flex;gap:12px;align-items:center;font-size:12px}
.dot{width:10px;height:10px;background:var(--accent);border-radius:50%}
.btn{padding:8px 12px;border:1px solid var(--border);background:var(--sub);color:inherit;border-radius:8px;cursor:pointer}
.container{padding:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.feed{position:relative;height:360px;background:#0c0c0c;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.feed img{max-width:100%;max-height:100%;object-fit:contain;display:none}
#map{height:260px;border-radius:10px}
.list{margin-top:8px;max-height:170px;overflow:auto;background:var(--chip);border:1px solid var(--border);border-radius:8px;padding:6px;font-family:monospace}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
.counter{padding:6px 10px;border:1px solid var(--border);background:var(--sub);border-radius:8px;color:var(--muted)}
.badge{font-size:12px;color:#fff;background:var(--danger);padding:3px 6px;border-radius:6px}
.note{max-width:1200px;margin:10px auto 0;color:var(--muted);font-size:12px}
.section-title{max-width:1200px;margin:0 auto 12px;font-weight:700;color:var(--accent);}
.zoom-controls{position:absolute;right:8px;top:8px;display:flex;gap:6px;z-index:10}
.zoom-btn{background:rgba(0,0,0,.55);border:1px solid var(--border);color:#fff;border-radius:8px;padding:6px 8px;font-size:13px;cursor:pointer}
</style>
</head>
<body>
<header>
<div>Drone surveillance dashboard</div>
<div class="status">
<div class="dot"></div><span>Operational</span>
<button id="themeBtn" class="btn">ðŸŒ™ Dark</button>
</div>
</header>

<h2 class="section-title">Possible violations</h2>

<div class="container">
<div class="grid">
<div class="card">
<div class="hdr"><strong>Images</strong><span id="fname" class="counter">â€”</span></div>
<div class="feed" id="feedBox">
<div class="zoom-controls">
<button id="zoomIn" class="zoom-btn">ï¼‹</button>
<button id="zoomOut" class="zoom-btn">âˆ’</button>
<button id="zoomReset" class="zoom-btn">Reset</button>
</div>
<img id="feedImg" alt="">
<span id="imgErr" style="color:#aaa">Loadingâ€¦</span>
</div>
<div class="row" style="margin-top:6px;display:flex;gap:10px;flex-wrap:wrap">
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
const OWNER="Fatma-Alhosani", REPO="drone-dashboard", BRANCH="main";
const POLL_MS=15000, MAX_DELTA_MS=60000;
let photos=[], gps=[], pairs=[], visiblePairs=[], idx=0;
let hiddenKeys=new Set(JSON.parse(localStorage.getItem("hidden_keys_v1")||"[]"));
let firstLoad=false;

const img=document.getElementById('feedImg');
const imgErr=document.getElementById('imgErr');
const fname=document.getElementById('fname');
const dateTxt=document.getElementById('dateTxt');
const timeTxt=document.getElementById('timeTxt');
const pairCounter=document.getElementById('pairCounter');
const gpsCount=document.getElementById('gpsCount');
const coordBadge=document.getElementById('coordBadge');
const gpsList=document.getElementById('gpsList');
const dbg=document.getElementById('dbg');

const map=L.map('map').setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map);
const marker=L.marker([0,0]).addTo(map);

function parseTsMs(key){
const m=key.match(/^(\d{4}-\d{2}-\d{2}).?(\d{2})[-:](\d{2})[-:](\d{2})$/);
if(!m)return null;
const d=new Date(Date.UTC(+m[1].slice(0,4),+m[1].slice(5,7)-1,+m[1].slice(8,10),+m[2],+m[3],+m[4]));
return d.getTime();
}
async function ghList(p){const u=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}&t=${Date.now()}`;const r=await fetch(u);if(!r.ok)throw new Error(p+" "+r.status);return r.json();}
async function ghGetText(p){const u=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}&t=${Date.now()}`;const r=await fetch(u);if(!r.ok)throw new Error(p+" "+r.status);const j=await r.json();return atob(j.content||"");}

async function loadRepo(){
const pItems=(await ghList("photos")).filter(x=>x.type==="file"&&/\.(jpg|jpeg|png)$/i.test(x.name));
photos=pItems.map(it=>{const k=it.name.replace(/\.[^.]+$/,"");const ts=parseTsMs(k);return ts?{key:k,tsMs:ts,url:it.download_url,name:it.name}:null;}).filter(Boolean).sort((a,b)=>a.tsMs-b.tsMs);
const gItems=(await ghList("GPS")).filter(x=>x.type==="file"&&/\.txt$/i.test(x.name));
gps=[];
for(const it of gItems){
const k=it.name.replace(/\.[^.]+$/,"");const ts=parseTsMs(k);if(!ts)continue;
const t=await ghGetText(`GPS/${it.name}`);const m=t.match(/(-?\d+\.\d+)[^\d-]+(-?\d+\.\d+)/);
if(m)gps.push({key:k,tsMs:ts,lat:+m[1],lon:+m[2]});
}
}
function buildPairs(){
pairs=[];if(!photos.length||!gps.length)return;
let p=0;
for(const g of gps){
while(p+1<photos.length&&photos[p+1].tsMs<=g.tsMs)p++;
const best=p;const d=Math.abs(photos[best].tsMs-g.tsMs);
if(d<=MAX_DELTA_MS)pairs.push({photo:photos[best],gps:g});
}
visiblePairs=pairs;idx=visiblePairs.length?visiblePairs.length-1:0;
}
function tsToParts(k){const m=k.match(/^(\d{4}-\d{2}-\d{2}).?(\d{2})-(\d{2})-(\d{2})$/);return m?{d:m[1],t:`${m[2]}:${m[3]}:${m[4]}`}:{d:"â€”",t:"â€”"};}
function show(){
if(!visiblePairs.length){img.style.display="none";imgErr.textContent="No images";return;}
const pr=visiblePairs[idx];
img.src=pr.photo.url;
img.onload=()=>{
img.style.display="block";
imgErr.textContent="";
};
const p=tsToParts(pr.photo.key);
fname.textContent=pr.photo.name;
dateTxt.textContent="Date: "+p.d;
timeTxt.textContent="Time: "+p.t;
coordBadge.textContent=`${pr.gps.lat.toFixed(5)}, ${pr.gps.lon.toFixed(5)}`;
gpsList.innerHTML=gps.map(x=>`${x.lat.toFixed(5)}, ${x.lon.toFixed(5)} [${x.key}]`).join("<br>");
map.setView([pr.gps.lat,pr.gps.lon],16);marker.setLatLng([pr.gps.lat,pr.gps.lon]);
pairCounter.textContent=`Pair ${idx+1} of ${visiblePairs.length}`;
gpsCount.textContent=`${gps.length} items`;
dbg.textContent="Loaded OK";
}
async function reload(){
try{
await loadRepo();buildPairs();show();
}catch(e){dbg.textContent="Error: "+e.message;}
}
document.getElementById("prevBtn").onclick=()=>{if(idx>0){idx--;show();}};
document.getElementById("nextBtn").onclick=()=>{if(idx<visiblePairs.length-1){idx++;show();}};
document.getElementById("refreshBtn").onclick=()=>window.location.reload();

let zoom=1,tx=0,ty=0;const ZMIN=1,ZMAX=5,STEP=0.25;
function applyZoom(){img.style.transform=`translate(${tx}px,${ty}px) scale(${zoom})`;}
document.getElementById("zoomIn").onclick=()=>{zoom=Math.min(ZMAX,zoom+STEP);applyZoom();};
document.getElementById("zoomOut").onclick=()=>{zoom=Math.max(ZMIN,zoom-STEP);applyZoom();};
document.getElementById("zoomReset").onclick=()=>{zoom=1;tx=ty=0;applyZoom();};
let drag=false,sx=0,sy=0,stx=0,sty=0;
document.getElementById("feedBox").addEventListener("pointerdown",e=>{if(zoom<=1)return;drag=true;sx=e.clientX;sy=e.clientY;stx=tx;sty=ty;});
document.getElementById("feedBox").addEventListener("pointermove",e=>{if(!drag)return;tx=stx+(e.clientX-sx);ty=sty+(e.clientY-sy);applyZoom();});
document.getElementById("feedBox").addEventListener("pointerup",()=>drag=false);

reload();
setInterval(reload,POLL_MS);
</script>
</body>
</html>
