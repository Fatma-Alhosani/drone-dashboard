/* ---------- refresh loop (force-capable) ---------- */
async function reloadGpsDriven(force = false){
  try{
    const gpsChanged = await loadGpsFromTxt();
    const photos = await loadPhotos();
    const photosChanged = !!photos;

    // Always rebuild on force or any change
    if (force || gpsChanged || photosChanged) {
      buildPairsGpsDriven(photos || []);
      // Jump to newest; if none, go to first GPS (photo optional)
      currentPairIndex = pairs.length ? pairs.length - 1 : 0;
      diagEl.textContent = `diag: refreshed photos=${photos?photos.length:"(cached)"} gps=${gpsData.length} pairs=${pairs.length}`;
      return true;
    }
    diagEl.textContent = `diag: no new data (cached) gps=${gpsData.length} pairs=${pairs.length}`;
    return false;
  } catch (e) {
    diagEl.textContent = `diag error: ${e.message}`;
    console.error(e);
    return false;
  }
}

async function rebuildAndShowLatest(force=false){
  await reloadGpsDriven(force);
  if (!pairs.length){
    // still show the most recent GPS even if no photo pairs were built
    if (gpsData.length) {
      const last = gpsData[gpsData.length - 1];
      showGPS(last);
    }
    updateCounter();
    feedImg.style.display="none";
    feedPlaceholder.style.display="flex";
    feedPlaceholder.textContent = pairs.length ? "Loadingâ€¦" : "No photo paired for latest GPS";
    return;
  }
  await showPair(currentPairIndex);
}

// hook button
async function manualRefresh(){
  diagEl.textContent = "diag: refreshing...";
  photosFingerprint = "";
  gpsFingerprint = "";
  await rebuildAndShowLatest(true); // force
}
