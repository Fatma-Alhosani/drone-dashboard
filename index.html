<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
const githubRepo = "Fatma-Alhosani/drone-dashboard";
const photosPath = "photos";
const gpsFile    = "GPS/gps_log.csv";

let pairs = [], gpsData = [], currentPairIndex = 0;

// --- change detection state ---
let photosFingerprint = ""; // concat of file shas
let gpsSha = "";            // sha of gps_log.csv

// DOM
const feedImg = document.getElementById("feedImg");
const feedPlaceholder = document.getElementById("feedPlaceholder");
const filenameDisplayEl = document.getElementById("filenameDisplay");
const pairCounterEl = document.getElementById("pairCounter");
const currentCoordEl = document.getElementById("currentCoord");
const currentTimeEl = document.getElementById("currentTime");
const coordinatesListEl = document.getElementById("coordinatesList"); // <-- was missing

// Map
const map = L.map("map").setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {attribution:"&copy; OpenStreetMap"}).addTo(map);
const marker = L.marker([0,0]).addTo(map);

// --- GitHub helpers (no token needed, read-only) ---
async function ghGetJSON(path){ const r=await fetch(`https://api.github.com/repos/${githubRepo}/${path}`); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function ghGetRaw(path){ const r=await fetch(`https://raw.githubusercontent.com/${githubRepo}/main/${path}?ts=${Date.now()}`); if(!r.ok) throw new Error(await r.text()); return r.text(); }

// --- data loading ---
function baseName(name){ const i=name.lastIndexOf('.'); return i>0?name.slice(0,i):name; }

async function loadGPS(){
  // use Contents API to get sha for change detection, fetch raw for speed
  const meta = await ghGetJSON(`contents/${gpsFile}`);
  if (meta.sha !== gpsSha) {
    gpsSha = meta.sha;
    const text = await ghGetRaw(gpsFile);
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const header = lines[0].split(",");
    const idxTime = header.findIndex(h=>/time|timestamp/i.test(h));
    const idxLat  = header.findIndex(h=>/lat/i.test(h));
    const idxLon  = header.findIndex(h=>/lon|lng/i.test(h));
    gpsData = lines.slice(1).map(r=>{
      const c=r.split(",");
      return { key:c[idxTime], lat:parseFloat(c[idxLat]), lon:parseFloat(c[idxLon]) };
    });
  }
}

async function loadPhotosAndBuildPairs(){
  // list photos folder, build fingerprint from shas (changes when files change)
  const items = await ghGetJSON(`contents/${photosPath}`);
  const files = items.filter(i=>i.type==="file" && /\.(jpg|jpeg|png)$/i.test(i.name));
  const newFingerprint = files.map(f=>f.sha).join(":");
  if (newFingerprint === photosFingerprint && gpsData.length) return false; // nothing new

  photosFingerprint = newFingerprint;

  // build pairs by matching photo basename to gps timestamp key
  pairs = files.map(i=>{
    const key = baseName(i.name);
    const gps = gpsData.find(g=>g.key === key);
    return gps ? { photo:{ name:i.name, url:i.download_url }, gps } : null;
  }).filter(Boolean);

  pairs.sort((a,b)=>a.photo.name.localeCompare(b.photo.name));
  if (pairs.length) currentPairIndex = pairs.length - 1;
  return true;
}

function updateCounter(){
  pairCounterEl.textContent = `Pair ${pairs.length ? (currentPairIndex+1) : 0} of ${pairs.length}`;
}

async function showPair(i){
  if (i<0 || i>=pairs.length) return;
  const pair = pairs[i];
  await loadImage(pair.photo);
  showGPS(pair.gps);
  updateCounter();
}

async function loadImage(info){
  feedPlaceholder.style.display="flex";
  feedImg.style.display="none";
  return new Promise(res=>{
    const img = new Image();
    const url = info.url + "?" + Date.now(); // cache-bust
    img.onload = ()=>{
      feedImg.src = url;
      feedImg.style.display="block";
      feedPlaceholder.style.display="none";
      filenameDisplayEl.textContent = info.name;
      res();
    };
    img.onerror = ()=>{ feedPlaceholder.textContent="Error loading image"; res(); };
    img.src = url;
  });
}

function showGPS(g){
  currentCoordEl.textContent = `${g.lat.toFixed(5)}, ${g.lon.toFixed(5)}`;
  currentTimeEl.textContent  = `timestamp: ${g.key}`;
  map.setView([g.lat,g.lon], 15);
  marker.setLatLng([g.lat,g.lon]);

  coordinatesListEl.innerHTML = "";
  gpsData.forEach(r=>{
    const el = document.createElement("div");
    el.textContent = `${r.lat.toFixed(5)}, ${r.lon.toFixed(5)} [${r.key}]`;
    if (r.key === g.key) el.classList.add("active-coordinate");
    coordinatesListEl.appendChild(el);
  });
}

// --- controls ---
document.getElementById("nextBtn").onclick = ()=>{ if(currentPairIndex < pairs.length-1){ currentPairIndex++; showPair(currentPairIndex);} };
document.getElementById("prevBtn").onclick = ()=>{ if(currentPairIndex > 0){ currentPairIndex--; showPair(currentPairIndex);} };
document.getElementById("refreshBtn").onclick = manualRefresh;

window.addEventListener("keydown", e=>{
  if(e.key==="ArrowRight") document.getElementById("nextBtn").click();
  if(e.key==="ArrowLeft")  document.getElementById("prevBtn").click();
  if(e.key.toLowerCase()==="r") document.getElementById("refreshBtn").click();
});

// --- refresh logic ---
async function rebuildAndShowLatest(){
  await loadGPS();
  const changed = await loadPhotosAndBuildPairs();
  if (!pairs.length) { pairCounterEl.textContent = "Pair 0 of 0"; return; }
  if (changed) await showPair(currentPairIndex); // show (new) latest
}

async function manualRefresh(){
  photosFingerprint = ""; // force reload
  gpsSha = "";
  await rebuildAndShowLatest();
}

// initial load
window.addEventListener("DOMContentLoaded", rebuildAndShowLatest);

// auto-poll for updates (30s keeps under anonymous API rate limits)
setInterval(rebuildAndShowLatest, 30000);
</script>
