<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Drone Surveillance Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#0f0f10; --card:#1a1b1e; --sub:#141518; --accent:#4CAF50; --muted:#a7a7a7; --danger:#c93a3a; --border:#2a2b2f;
  }
  body{margin:0;background:var(--bg);color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#000;border-bottom:1px solid var(--border)}
  header .status{font-size:12px;color:#9fe79f}
  .wrap{padding:18px;display:flex;justify-content:center}
  .grid{width:min(1200px,100%);display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  .pane{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .pane h3{margin:0;padding:10px 12px;background:var(--sub);border-bottom:1px solid var(--border);font-size:13px;letter-spacing:.3px;color:#ddd}
  .meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);padding:8px 12px;border-top:1px solid var(--border);background:var(--sub)}
  .controls{display:flex;gap:10px;justify-content:center;padding:12px;background:var(--sub);border-top:1px solid var(--border)}
  button{border:1px solid var(--border);background:#232427;color:#fff;padding:9px 14px;border-radius:8px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .btn{background:#2a2b31}
  .btn.primary{background:var(--accent);border-color:#3a8f43}
  .btn.danger{background:var(--danger);border-color:#942b2b}
  .counter{font-size:12px;color:var(--muted)}
  .feed{height:360px;display:flex;align-items:center;justify-content:center;background:#0f1012}
  #photo{max-width:100%;max-height:100%;object-fit:contain}
  #map{height:360px}
  .foot{padding:6px 12px;font-size:11px;color:#7c7c7c}
</style>
</head>
<body>
<header>
  <div>üõ∞Ô∏è DRONE SURVEILLANCE DASHBOARD</div>
  <div class="status">GitHub Pages ¬∑ static</div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Images -->
    <div class="pane">
      <h3 id="imgTitle">Images</h3>
      <div class="feed"><img id="photo" alt="No image"/></div>
      <div class="meta">
        <span id="dateMeta">Date: ‚Äî</span>
        <span id="timeMeta">Time: ‚Äî</span>
        <span class="counter" id="pairMeta">Pair 0 of 0</span>
      </div>
      <div class="controls">
        <button class="btn" id="prevBtn">Previous</button>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="nextBtn">Next</button>
        <button class="btn danger" id="discardBtn">Discard</button>
      </div>
      <div class="foot" id="dbg"></div>
    </div>

    <!-- GPS -->
    <div class="pane">
      <h3>GPS Coordinates</h3>
      <div id="map"></div>
      <div class="meta">
        <span id="gpsCount">0 items</span>
        <span id="gpsCoord" style="margin-left:auto">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =============================
   STRICT filename pairing (Pages)
   - Uses photos.json only
   - For each photo key, GET GPS/<key>.txt
   - Keep only pairs where GPS exists + parses
   - Discard hides by key (localStorage)
   ============================= */

let pairs = [];     // [{key, photoName, photoUrl, lat, lng}]
let idx = 0;
let discarded = new Set(JSON.parse(localStorage.getItem("discarded_keys") || "[]"));

const imgTitle = document.getElementById("imgTitle");
const photoEl  = document.getElementById("photo");
const dateEl   = document.getElementById("dateMeta");
const timeEl   = document.getElementById("timeMeta");
const pairEl   = document.getElementById("pairMeta");
const gpsCount = document.getElementById("gpsCount");
const gpsCoord = document.getElementById("gpsCoord");
const dbgEl    = document.getElementById("dbg");

const map = L.map("map").setView([25.3131, 55.4910], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let marker = L.marker([25.3131, 55.4910]).addTo(map);

function baseNoExt(name){
  const b = name.replace(/^.*\//,"");
  const dot = b.lastIndexOf(".");
  return dot>0 ? b.slice(0,dot) : b;
}

function parseDateTimeFromKey(key){
  // supports 2025-10-12_14-34-39 or 2025-10-12|14-34-39
  const date = key.slice(0,10);
  const time = key.slice(-8).replaceAll("-",":");
  return {date, time};
}

function parseLatLonFromText(text){
  // Try: lat: 25.31311 lon: 55.49100  OR "25.31311, 55.49100"  OR first two floats
  let m = text.match(/lat\D*(-?\d+(?:\.\d+)?)\D*lon\D*(-?\d+(?:\.\d+)?)/i);
  if (!m) m = text.match(/(-?\d+(?:\.\d+)?)\D*,\D*(-?\d+(?:\.\d+)?)/);
  if (!m) {
    const all = [...text.matchAll(/-?\d+(?:\.\d+)?/g)].map(x=>parseFloat(x[0]));
    if (all.length>=2) m = [null, all[0], all[1]];
  }
  if (!m) return null;
  const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
  if (Math.abs(lat)>90 || Math.abs(lng)>180) return null;
  return {lat, lng};
}

async function fetchGpsForKey(key){
  // Try same-origin first (Pages): GPS/<key>.txt
  // If you serve under a subfolder, this relative path still works.
  const url = `GPS/${key}.txt?ts=${Date.now()}`;
  const r = await fetch(url);
  if (!r.ok) return null;
  const text = await r.text();
  const coords = parseLatLonFromText(text);
  return coords;
}

async function loadAll(){
  dbgEl.textContent = "loading‚Ä¶";
  let photos = [];
  try{
    photos = await fetch("photos.json?ts="+Date.now()).then(r=>r.json());
  }catch(e){
    dbgEl.textContent = "photos.json load error";
    console.error(e);
    photos = [];
  }

  // Build & pair by probing GPS/<key>.txt
  const out = [];
  let tested = 0, kept = 0, skipped = 0;

  // Sort chronological by name
  photos.sort((a,b)=>a.name.localeCompare(b.name));

  for (const p of photos){
    const key = baseNoExt(p.name);
    if (discarded.has(key)) { skipped++; continue; }

    tested++;
    try{
      const coords = await fetchGpsForKey(key);
      if (coords){
        out.push({
          key,
          photoName: p.name,
          photoUrl:  p.url,
          lat: coords.lat,
          lng: coords.lng
        });
        kept++;
      }else{
        skipped++;
      }
    }catch(err){
      console.warn("GPS fetch fail for", key, err);
      skipped++;
    }
  }

  pairs = out;
  idx = Math.min(idx, Math.max(pairs.length-1, 0));
  dbgEl.textContent = `dbg: photos=${photos.length} tested=${tested} kept=${kept} skipped=${skipped} hidden=${discarded.size}`;
  render();
}

function render(){
  const total = pairs.length;
  if (total === 0){
    imgTitle.textContent = "Images";
    photoEl.src = "";
    photoEl.alt = "No images available";
    dateEl.textContent = "Date: ‚Äî";
    timeEl.textContent = "Time: ‚Äî";
    pairEl.textContent = "Pair 0 of 0";
    gpsCount.textContent = "0 items";
    gpsCoord.textContent = "GPS error";
    marker.setLatLng([25.3131,55.4910]);
    map.setView([25.3131,55.4910], 15);
    return;
  }
  const cur = pairs[idx];
  imgTitle.textContent = cur.photoName;
  photoEl.src = cur.photoUrl;
  photoEl.alt = cur.photoName;

  const {date,time} = parseDateTimeFromKey(cur.key);
  dateEl.textContent = "Date: " + date;
  timeEl.textContent = "Time: " + time;
  pairEl.textContent = `Pair ${idx+1} of ${total}`;

  gpsCount.textContent = `${total} items`; // count of valid synced pairs
  gpsCoord.textContent = `${cur.lat.toFixed(6)}, ${cur.lng.toFixed(6)}`;
  marker.setLatLng([cur.lat,cur.lng]);
  map.setView([cur.lat,cur.lng], 17);
}

/* Controls */
document.getElementById("nextBtn").onclick = ()=>{
  if (!pairs.length) return;
  idx = (idx+1) % pairs.length;
  render();
};
document.getElementById("prevBtn").onclick = ()=>{
  if (!pairs.length) return;
  idx = (idx-1+pairs.length) % pairs.length;
  render();
};
document.getElementById("refreshBtn").onclick = ()=>{
  loadAll().catch(console.error);
};
document.getElementById("discardBtn").onclick = ()=>{
  if (!pairs.length) return;
  const key = pairs[idx].key;

  discarded.add(key);
  localStorage.setItem("discarded_keys", JSON.stringify([...discarded]));

  pairs.splice(idx,1);
  if (idx >= pairs.length) idx = 0;
  render();
};

// keyboard arrows
window.addEventListener("keydown",(e)=>{
  if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
  if (e.key === "ArrowLeft")  document.getElementById("prevBtn").click();
});

/* Boot */
loadAll().catch(console.error);
</script>
</body>
</html>
