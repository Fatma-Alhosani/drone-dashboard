<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Drone Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <style>
    body{margin:0;font-family:'Segoe UI',Tahoma,sans-serif;background:#111;color:#fff;}
    header{background:#000;padding:15px 30px;font-size:20px;font-weight:bold;
      display:flex;justify-content:space-between;align-items:center;}
    .wrap{padding:28px;display:flex;justify-content:center;}
    .violations{width:min(1200px,100%);background:#1e1e1e;border-radius:14px;
      padding:18px;box-shadow:0 0 18px rgba(0,0,0,.35);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .pane{background:#151515;border-radius:10px;padding:14px;}
    #map{height:260px;border-radius:10px;margin-top:6px;}
    .controls{display:flex;align-items:center;justify-content:center;gap:10px;margin:16px 6px;}
    .control-btn{background:#333;color:#fff;border:1px solid #444;padding:10px 18px;
      border-radius:8px;cursor:pointer;}
  </style>
</head>
<body>
<header>
  <div>DRONE SURVEILLANCE DASHBOARD</div>
  <div id="connectionStatus" style="color:#4CAF50;">OPERATIONAL</div>
</header>

<div class="wrap">
  <section class="violations">
    <div class="grid">
      <div class="pane">
        <h3>Latest Image</h3>
        <div id="feedPlaceholder" style="text-align:center;color:#bbb;">Loading…</div>
        <img id="feedImg" style="width:100%;display:none;border-radius:10px;"/>
      </div>
      <div class="pane">
        <h3>GPS Coordinates</h3>
        <div id="map"></div>
        <div id="coordInfo" style="margin-top:10px;font-family:monospace;"></div>
      </div>
    </div>
    <div class="controls">
      <button class="control-btn" id="prevBtn">Previous</button>
      <button class="control-btn" id="refreshBtn">Refresh</button>
      <button class="control-btn" id="nextBtn">Next</button>
      <button class="control-btn" id="discardBtn" style="background:#b21c1c;">Discard</button>
    </div>
  </section>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
let pairs = [], currentPairIndex = 0;
const feedImg = document.getElementById("feedImg");
const feedPlaceholder = document.getElementById("feedPlaceholder");
const coordInfo = document.getElementById("coordInfo");
const map = L.map("map").setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
 {attribution:"© OpenStreetMap"}).addTo(map);
const marker = L.marker([0,0]).addTo(map);

async function loadData() {
  const [photosRes, gpsRes] = await Promise.all([
    fetch("/repo/photos"), fetch("/repo/gps")
  ]);
  const photos = (await photosRes.json()).photos || [];
  const gps = (await gpsRes.json()).gps || [];

  pairs = [];
  for (const g of gps) {
    const match = photos.find(p => p.key === g.key);
    if (match) pairs.push({ photo: match, gps: g });
  }
  if (!pairs.length) {
    feedPlaceholder.textContent = "No data found.";
    return;
  }
  pairs.sort((a,b)=>a.photo.key.localeCompare(b.photo.key));
  currentPairIndex = pairs.length - 1; // most recent
  showPair(currentPairIndex);
}

async function showPair(i){
  if(i<0 || i>=pairs.length)return;
  const pair = pairs[i];
  feedImg.src = pair.photo.download_url;
  feedImg.style.display = "block";
  feedPlaceholder.style.display = "none";
  coordInfo.textContent = `Lat: ${pair.gps.lat}, Lon: ${pair.gps.lon} (${pair.photo.key})`;
  map.setView([pair.gps.lat, pair.gps.lon], 15);
  marker.setLatLng([pair.gps.lat, pair.gps.lon]);
}

document.getElementById("nextBtn").onclick = ()=>{ if(currentPairIndex<pairs.length-1){ currentPairIndex++; showPair(currentPairIndex);} };
document.getElementById("prevBtn").onclick = ()=>{ if(currentPairIndex>0){ currentPairIndex--; showPair(currentPairIndex);} };
document.getElementById("refreshBtn").onclick = loadData;

document.getElementById("discardBtn").onclick = async ()=>{
  if(!pairs.length) return alert("No photo to discard.");
  const pair = pairs[currentPairIndex];
  if(!pair.photo) return alert("No photo found for this pair.");
  if(!confirm(`Discard ${pair.photo.name}?`)) return;
  const resp = await fetch(`/discard?path=photos/${pair.photo.name}`, { method:"DELETE" });
  const data = await resp.json();
  if(data.ok){
    alert("Photo discarded successfully!");
    await loadData();
  } else {
    alert("Error: " + (data.error || resp.statusText));
  }
};

window.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
