<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Drone surveillance dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<style>
:root{ --bg:#121212; --card:#1e1e1e; --sub:#151515; --accent:#4CAF50; --muted:#9aa; --border:#333; --danger:#b43; --chip:#2b2b2b; }
body.light{ --bg:#f7f7f7; --card:#fff; --sub:#f0f0f0; --accent:#0066cc; --muted:#555; --border:#ccc; --danger:#c33; --chip:#e8e8e8; color:#000; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Arial,sans-serif;}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#000;}
.status{display:flex;gap:12px;align-items:center;font-size:12px}
.dot{width:10px;height:10px;background:var(--accent);border-radius:50%}
.btn{padding:8px 12px;border:1px solid var(--border);background:var(--sub);color:inherit;border-radius:8px;cursor:pointer}
.container{padding:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

/* FEED: fixed to fit image into box first, then zoom from there */
.feed{position:relative;height:360px;background:#0c0c0c;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.feed img{display:none; /* shown onload */}
#map{height:260px;border-radius:10px}

/* pan/zoom host layer that we transform */
.img-layer{
position:absolute; left:50%; top:50%;
transform-origin: 0 0; /* we translate to the centered origin below */
will-change: transform;
<h2 class="section-title">Possible violations</h2>

<div class="container">
<div class="grid">
<div class="card">
<div class="hdr"><strong>Images</strong><span id="fname" class="counter">—</span></div>
<div class="feed" id="feedBox">
<div class="zoom-controls">
<button id="zoomIn" class="zoom-btn">＋</button>
<button id="zoomOut" class="zoom-btn">−</button>
<button id="zoomReset" class="zoom-btn">Reset</button>
</div>
<!-- layer we actually transform to keep fit-in-box baseline -->
<div id="imgLayer" class="img-layer">
<img id="feedImg" alt="">
</div>
<div id="toast">
<h4>A new possible violation detected</h4>
<p>A new image+GPS pair has arrived.</p>
<div class="toast-actions">
<button id="toastDismiss" class="toast-btn">Dismiss</button>
<button id="toastDisplay" class="toast-btn toast-primary">Display</button>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
/* ====== CONFIG ====== */
const OWNER="Fatma-Alhosani", REPO="drone-dashboard", BRANCH="main";
const POLL_MS=15000, MAX_DELTA_MS=60000;
/* ==================== */

let photos=[], gps=[], pairs=[], visiblePairs=[], idx=0;
let hiddenKeys = new Set(JSON.parse(localStorage.getItem("hidden_keys_v1") || "[]"));
let lastSeenLatestTs = Number(localStorage.getItem("last_seen_latest_ts_v2") || "0");
let firstLoadDone = false;

/* DOM */
const imgEl=document.getElementById('feedImg');
const imgLayer=document.getElementById('imgLayer');
const imgErr=document.getElementById('imgErr');
const feedBox=document.getElementById('feedBox');
const fname=document.getElementById('fname');
const dateTxt=document.getElementById('dateTxt');
const timeTxt=document.getElementById('timeTxt');
const pairCounter=document.getElementById('pairCounter');
const gpsCount=document.getElementById('gpsCount');
const coordBadge=document.getElementById('coordBadge');
const gpsList=document.getElementById('gpsList');
const dbg=document.getElementById('dbg');
const toast=document.getElementById('toast');
const toastDismiss=document.getElementById('toastDismiss');
const toastDisplay=document.getElementById('toastDisplay');

const pItems=(await ghList("photos")).filter(x=>x.type==="file" && /\.(jpg|jpeg|png|webp)$/i.test(x.name));
photos=pItems.map(it=>{
const key=it.name.replace(/\.[^.]+$/,""); const ts=parseTsMs(key);
return ts?{name:it.name,key,tsMs:ts,url:it.download_url}:null;
}).filter(Boolean).filter(p=>!hiddenKeys.has(p.key)).sort((a,b)=>a.tsMs-b.tsMs);
}catch(e){
photos = await loadPhotosFromJson();
}

try{
const gItems=(await ghList("GPS")).filter(x=>x.type==="file" && /\.txt$/i.test(x.name));
const rows=[];
for(const it of gItems){
const key=it.name.replace(/\.[^.]+$/,""); const ts=parseTsMs(key); if(!ts) continue;
const text=await ghGetText(`GPS/${it.name}`); const m=text.match(/lat\D*(-?\d+(?:\.\d+)?)\D*lon\D*(-?\d+(?:\.\d+)?)/i) || text.match(/(-?\d+(?:\.\d+)?)[^\d-]+(-?\d+(?:\.\d+)?)/);
let lat,lon;
if(m){lat=+m[1]; lon=+m[2];}
else{
const nums = Array.from(text.matchAll(/-?\d+(?:\.\d+)?/g)).map(x=>x[0]);
if(nums.length>=2){lat=+nums[0]; lon=+nums[1];}
}
if(!isFinite(lat)||!isFinite(lon)||Math.abs(lat)>90||Math.abs(lon)>180) continue;
rows.push({key,tsMs:ts,lat,lon,path:`GPS/${it.name}`});
}
gps=rows.filter(r=>!hiddenKeys.has(r.key)).sort((a,b)=>a.tsMs-b.tsMs);
}catch(e){
gps = await loadGpsFromJson();
}
}

function buildPairs(){
pairs=[]; if(!photos.length||!gps.length) return;
let p=0;
for(const g of gps){
while(p+1<photos.length && photos[p+1].tsMs<=g.tsMs) p++;
const cand=[p]; if(p>0)cand.push(p-1);
let best=-1, diff=1e15;
for(const i of cand){const d=Math.abs(photos[i].tsMs-g.tsMs); if(d<diff){diff=d; best=i;}}
if(best>=0 && diff<=MAX_DELTA_MS) pairs.push({gps:g, photo:photos[best]});
}
visiblePairs=pairs.filter(pr=>!hiddenKeys.has(pr.photo.key));
idx = visiblePairs.length ? (visiblePairs.length - 1) : 0; // latest first
}

function updateCounters(){
pairCounter.textContent=`Pair ${visiblePairs.length?(idx+1):0} of ${visiblePairs.length}`;
gpsCount.textContent=`${gps.length} items`;
}

/* ---------- FIT-IN-BOX BASE SCALE, THEN ZOOM ---------- */
let baseScale=1, zoom=1, tx=0, ty=0; // tx/ty are additional pans on top of centered fit
const Z_MIN=1, Z_MAX=5, Z_STEP=0.25;
const zoomInBtn=document.getElementById('zoomIn');
const zoomOutBtn=document.getElementById('zoomOut');
const zoomResetBtn=document.getElementById('zoomReset');

function computeBaseFit(){
// fit the image fully into feedBox
const boxW = feedBox.clientWidth, boxH = feedBox.clientHeight;
const iw = imgEl.naturalWidth, ih = imgEl.naturalHeight;
baseScale = Math.min(boxW/iw, boxH/ih);
// center the image at zoom=1
const drawW = iw*baseScale, drawH = ih*baseScale;
// we use translate to move the top-left of imgLayer so its center is at feed center
const originX = -drawW/2, originY = -drawH/2;
// base centering lives in the layer transform; tx/ty do extra panning
imgLayer.dataset.originX = originX;
imgLayer.dataset.originY = originY;
}

function applyTransform(){
const ox = parseFloat(imgLayer.dataset.originX||0);
const oy = parseFloat(imgLayer.dataset.originY||0);
imgLayer.style.transform = `translate(calc(50% + ${ox + tx}px), calc(50% + ${oy + ty}px)) scale(${baseScale*zoom})`;
}

function resetZoom(){
zoom=1; tx=0; ty=0; applyTransform();
}

function show(){
if(!visiblePairs.length){
imgEl.style.display='none'; imgErr.style.display='block'; imgErr.textContent='No visible pairs';
fname.textContent='—'; dateTxt.textContent='Date: —'; timeTxt.textContent='Time: —'; coordBadge.textContent='—, —';
gpsList.innerHTML=''; updateCounters(); return;
}
const pr=visiblePairs[idx];
imgEl.src=pr.photo.url;
imgEl.onload=()=>{
imgEl.style.display='block';
imgErr.style.display='none';
computeBaseFit(); resetZoom(); // ensures it’s fitted to the box
};
imgEl.onerror=()=>{imgEl.style.display='none';imgErr.style.display='block';imgErr.textContent='Image error';};
fname.textContent=pr.photo.name;
const parts=tsToParts(pr.photo.key); dateTxt.textContent='Date: '+parts.date; timeTxt.textContent='Time: '+parts.time;
coordBadge.textContent=`${pr.gps.lat.toFixed(5)}, ${pr.gps.lon.toFixed(5)}`;
map.setView([pr.gps.lat,pr.gps.lon],16); marker.setLatLng([pr.gps.lat,pr.gps.lon]);
gpsList.innerHTML='';
for(const r of gps){
const el=document.createElement('div');
el.textContent=`${r.lat.toFixed(5)}, ${r.lon.toFixed(5)} [${r.key}]`;
if(r.key===pr.gps.key){el.style.fontWeight='bold'; el.style.background='#242424';}
gpsList.appendChild(el);
}
updateCounters();
}

/* toast helpers */
function showToast(){ toast.style.display='block'; }
function hideToast(){ toast.style.display='none'; }

/* main reload */
async function reload(){
try{
await loadRepo();
buildPairs();

const latestTs = visiblePairs.length ? visiblePairs[visiblePairs.length-1].photo.tsMs : 0;
if(!firstLoadDone){
lastSeenLatestTs = latestTs;
localStorage.setItem("last_seen_latest_ts_v2", String(lastSeenLatestTs));
firstLoadDone = true;
}else{
if(latestTs > lastSeenLatestTs){ showToast(); }
}

if(!visiblePairs.length){ idx=0; }
show();
dbg.textContent=`dbg: ok | visiblePairs=${visiblePairs.length} (API+fallback)`;
}catch(e){
dbg.textContent='dbg: '+e.message;
}
}

/* controls */
document.getElementById('prevBtn').onclick=()=>{ if(idx>0){idx--;show();} };
document.getElementById('nextBtn').onclick=()=>{ if(idx<visiblePairs.length-1){idx++;show();} };

/* hard refresh page (forces re-fetch of everything) */
document.getElementById('refreshBtn').onclick=()=>{ window.location.reload(true); };

/* Discard: local hide (same as before) */
document.getElementById('discardBtn').onclick=()=>{
if(!visiblePairs.length) return;
const pr=visiblePairs[idx]; hiddenKeys.add(pr.photo.key); saveHidden();
const latestTs = visiblePairs.length ? visiblePairs[visiblePairs.length-1].photo.tsMs : 0;
if(latestTs > lastSeenLatestTs){ lastSeenLatestTs = latestTs; localStorage.setItem("last_seen_latest_ts_v2", String(lastSeenLatestTs)); }
reload();
};

document.getElementById('downloadBtn').onclick=()=>{
const lines=['# Discard Log', ...[...hiddenKeys].sort().map(k=>`- ${k}`)];
const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
saveAs(blob,`discard_log_${Date.now()}.txt`);
};

window.addEventListener('keydown',e=>{
if(e.key==='ArrowRight')document.getElementById('nextBtn').click();
if(e.key==='ArrowLeft')document.getElementById('prevBtn').click();
});

/* toast */
toastDismiss.onclick = ()=>{
const latestTs = visiblePairs.length ? visiblePairs[visiblePairs.length-1].photo.tsMs : 0;
lastSeenLatestTs = latestTs;
localStorage.setItem("last_seen_latest_ts_v2", String(lastSeenLatestTs));
hideToast();
};
toastDisplay.onclick = ()=>{
if(visiblePairs.length){ idx = visiblePairs.length - 1; show(); }
const latestTs = visiblePairs.length ? visiblePairs[visiblePairs.length-1].photo.tsMs : 0;
lastSeenLatestTs = latestTs;
localStorage.setItem("last_seen_latest_ts_v2", String(lastSeenLatestTs));
hideToast();
};

/* theme */
const themeBtn=document.getElementById('themeBtn');
function setTheme(light){document.body.classList.toggle("light",light);themeBtn.textContent=light?"☀️ Light":"🌙 Dark";localStorage.setItem("theme",light?"light":"dark");}
themeBtn.onclick=()=>setTheme(!document.body.classList.contains("light"));
if(localStorage.getItem("theme")==="light")setTheme(true);

/* zoom controls */
zoomInBtn.onclick = ()=>{ zoom=Math.min(Z_MAX, zoom+Z_STEP); applyTransform(); };
zoomOutBtn.onclick= ()=>{ zoom=Math.max(Z_MIN, zoom-Z_STEP); if(zoom===1){tx=0;ty=0;} applyTransform(); };
zoomResetBtn.onclick=()=> resetZoom();

/* wheel zoom */
feedBox.addEventListener('wheel', (e)=>{
if(imgEl.style.display==='none') return;
e.preventDefault();
const delta = Math.sign(e.deltaY);
if(delta<0) zoom=Math.min(Z_MAX, zoom+Z_STEP);
else zoom=Math.max(Z_MIN, zoom-Z_STEP);
if(zoom===1){ tx=ty=0; }
applyTransform();
}, {passive:false});

/* drag pan */
let dragging=false, startX=0, startY=0, startTx=0, startTy=0;
feedBox.addEventListener('pointerdown', (e)=>{
if(zoom<=1) return;
dragging=true; startX=e.clientX; startY=e.clientY; startTx=tx; startTy=ty; feedBox.setPointerCapture(e.pointerId);
});
feedBox.addEventListener('pointermove', (e)=>{
if(!dragging) return;
tx = startTx + (e.clientX - startX);
ty = startTy + (e.clientY - startY);
applyTransform();
});
feedBox.addEventListener('pointerup', ()=>{ dragging=false; });
feedBox.addEventListener('pointercancel', ()=>{ dragging=false; });

/* start */
reload();
setInterval(reload, POLL_MS);

/* Recompute base fit if the box size changes (e.g., window resize) */
window.addEventListener('resize', ()=>{
if(imgEl.complete && imgEl.naturalWidth) { computeBaseFit(); applyTransform(); }
});
</script>
</body>
</html>
