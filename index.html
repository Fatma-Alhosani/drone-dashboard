<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Drone Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<style>
:root{ --bg:#121212; --card:#1e1e1e; --sub:#151515; --accent:#4CAF50; --muted:#9aa; --border:#333; --danger:#b43; --chip:#2b2b2b; }
body.light{ --bg:#f7f7f7; --card:#fff; --sub:#f0f0f0; --accent:#0066cc; --muted:#555; --border:#ccc; --danger:#c33; --chip:#e8e8e8; color:#000; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Arial,sans-serif;}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#000;}
.status{display:flex;gap:12px;align-items:center;font-size:12px}
.dot{width:10px;height:10px;background:var(--accent);border-radius:50%}
.btn{padding:8px 12px;border:1px solid var(--border);background:var(--sub);color:inherit;border-radius:8px;cursor:pointer}
.container{padding:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.feed{height:360px;background:#0c0c0c;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.feed img{max-width:100%;max-height:100%;display:none}
#map{height:260px;border-radius:10px}
.list{margin-top:8px;max-height:170px;overflow:auto;background:var(--chip);border:1px solid var(--border);border-radius:8px;padding:6px;font-family:monospace}
.list .hidden{opacity:.45;text-decoration:line-through}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
.counter{padding:6px 10px;border:1px solid var(--border);background:var(--sub);border-radius:8px;color:var(--muted)}
.badge{font-size:12px;color:#fff;background:var(--danger);padding:3px 6px;border-radius:6px}
a.link{color:var(--accent);text-decoration:none;border-bottom:1px dotted var(--accent);padding-bottom:1px}
.note{max-width:1200px;margin:10px auto 0;color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div>DRONE SURVEILLANCE DASHBOARD</div>
  <div class="status">
    <div class="dot"></div><span>GitHub Pages (static)</span>
    <button id="themeBtn" class="btn">🌙 Dark</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card">
      <div class="hdr"><strong>IMAGES</strong><span id="fname" class="counter">—</span></div>
      <div class="feed"><img id="feedImg" alt=""><span id="imgErr" style="color:#aaa">Loading…</span></div>
      <div class="row" style="margin-top:6px">
        <span class="counter" id="dateTxt">Date: —</span>
        <span class="counter" id="timeTxt">Time: —</span>
        <span class="counter" id="pairCounter">Pair 0 of 0 (0 visible / 0 total)</span>
      </div>
      <div class="row" style="margin-top:6px">
        <a id="openPhoto" class="link" href="#" target="_blank" rel="noopener">Open photo on GitHub</a>
        <a id="openGPS" class="link" href="#" target="_blank" rel="noopener">Open GPS txt on GitHub</a>
      </div>
    </div>

    <div class="card">
      <div class="hdr">
        <strong>GPS COORDINATES</strong>
        <span class="counter" id="gpsCount">0 items</span>
      </div>
      <div class="card" style="padding:0;background:#2a0f0f;border-color:#3a1a1a">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px">
          <strong>Current GPS Location</strong>
          <span id="coordBadge" class="badge">lat, lon</span>
        </div>
        <div id="map"></div>
      </div>
      <div class="row" style="margin:8px 2px 4px">
        <strong>GPS List</strong>
        <label class="counter" style="cursor:pointer">
          <input type="checkbox" id="showHiddenChk" style="vertical-align:middle;margin-right:6px">Show hidden
        </label>
      </div>
      <div class="list" id="gpsList"></div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="prevBtn">Previous</button>
    <button class="btn" id="refreshBtn">Refresh</button>
    <button class="btn" id="nextBtn">Next</button>
    <button class="btn" style="background:#5a1313;border-color:#772020;color:#fff" id="discardBtn">Discard (Hide)</button>
    <button class="btn" style="background:#193;border-color:#1a4;color:#fff" id="downloadBtn">Download logs</button>
    <button class="btn" id="unhideAllBtn">Unhide all</button>
  </div>

  <div class="note" id="dbg">dbg: —</div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
/* ====== CONFIG ====== */
const OWNER="Fatma-Alhosani", REPO="drone-dashboard", BRANCH="main";
const POLL_MS=60000, MAX_DELTA_MS=60*1000;
/* ==================== */

let photos=[], gps=[], pairs=[], visiblePairs=[], idx=0;
let hiddenKeys = new Set(JSON.parse(localStorage.getItem("hidden_keys_v1") || "[]"));

const imgEl = document.getElementById('feedImg');
const imgErr = document.getElementById('imgErr');
const fname = document.getElementById('fname');
const dateTxt = document.getElementById('dateTxt');
const timeTxt = document.getElementById('timeTxt');
const pairCounter = document.getElementById('pairCounter');
const gpsCount = document.getElementById('gpsCount');
const coordBadge = document.getElementById('coordBadge');
const gpsList = document.getElementById('gpsList');
const dbg = document.getElementById('dbg');
const openPhoto = document.getElementById('openPhoto');
const openGPS = document.getElementById('openGPS');
const showHiddenChk = document.getElementById('showHiddenChk');

const map = L.map('map').setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
const marker = L.marker([0,0]).addTo(map);

function saveHidden(){ localStorage.setItem("hidden_keys_v1", JSON.stringify([...hiddenKeys])); }
function baseName(n){ const i=n.lastIndexOf('.'); return i>0?n.slice(0,i):n; }
function parseTsToMs(s){
  if(!s) return NaN;
  let m;
  m=s.match(/^(\d{4}-\d{2}-\d{2})[|_](\d{2})-(\d{2})-(\d{2})$/);
  if(m) return Date.parse(`${m[1]}T${m[2]}:${m[3]}:${m[4]}Z`);
  m=s.match(/^(\d{4}-\d{2}-\d{2}).?(\d{2})[-:](\d{2})[-:](\d{2})$/);
  if(m) return Date.parse(`${m[1]}T${m[2]}:${m[3]}:${m[4]}Z`);
  return NaN;
}
function tsToParts(key){
  const m = key.match(/^(\d{4}-\d{2}-\d{2}).?(\d{2})[-:](\d{2})[-:](\d{2})$/);
  if(!m) return {date:"—",time:"—"};
  return {date:m[1],time:`${m[2]}:${m[3]}:${m[4]}`};
}

async function loadJSON(path){
  const r = await fetch(path + '?t=' + Date.now());
  if(!r.ok) throw new Error(`get ${path} failed: ${r.status}`);
  return r.json();
}

async function reload(){
  try{
    photos = (await loadJSON('photos.json')).filter(p=>Number.isFinite(p.tsMs)).sort((a,b)=>a.tsMs-b.tsMs);
    gps = (await loadJSON('gps.json')).filter(g=>Number.isFinite(g.tsMs)).sort((a,b)=>a.tsMs-b.tsMs);
    buildPairs(); show();
    dbg.textContent = `dbg: ok | photos=${photos.length} gps=${gps.length} hidden=${hiddenKeys.size}`;
  }catch(e){
    dbg.textContent = 'dbg: '+e.message+' — Did the workflow run to generate photos.json & gps.json?';
  }
}

function buildPairs(){
  pairs = [];
  if(!photos.length || !gps.length) return;
  let p=0;
  for(const g of gps){
    while(p+1<photos.length && photos[p+1].tsMs<=g.tsMs) p++;
    const cand=[p]; if(p>0)cand.push(p-1);
    let best=-1, diff=1e12;
    for(const i of cand){ const d=Math.abs(photos[i].tsMs-g.tsMs); if(d<diff){diff=d;best=i;} }
    if(best>=0 && diff<=MAX_DELTA_MS) pairs.push({ gps:g, photo:photos[best] });
  }
  pairs.sort((a,b)=>a.photo.tsMs-b.photo.tsMs);
  filterVisible();
}

function filterVisible(){
  visiblePairs = pairs.filter(pr => !hiddenKeys.has(pr.photo.key));
  idx = visiblePairs.length ? visiblePairs.length-1 : 0; // show most recent visible
  updateCounters();
}
function updateCounters(){
  pairCounter.textContent = `Pair ${visiblePairs.length ? (idx+1) : 0} of ${visiblePairs.length} (visible) / ${pairs.length} (total)`;
  gpsCount.textContent = `${gps.length} items`;
}

function show(){
  if(!visiblePairs.length){
    imgEl.style.display='none'; imgErr.style.display='block'; imgErr.textContent='No visible pairs';
    fname.textContent='—'; dateTxt.textContent='Date: —'; timeTxt.textContent='Time: —';
    coordBadge.textContent='—, —'; gpsList.innerHTML='';
    openPhoto.href = `https://github.com/${OWNER}/${REPO}/tree/${BRANCH}/photos`;
    openGPS.href   = `https://github.com/${OWNER}/${REPO}/tree/${BRANCH}/GPS`;
    return;
  }
  const pr = visiblePairs[idx];
  // image
  imgEl.src = pr.photo.url;
  imgEl.onload = ()=>{ imgEl.style.display='block'; imgErr.style.display='none'; };
  imgEl.onerror = ()=>{ imgEl.style.display='none'; imgErr.style.display='block'; imgErr.textContent='Image error'; };
  fname.textContent = pr.photo.name;

  const parts = tsToParts(pr.photo.key);
  dateTxt.textContent = 'Date: '+parts.date;
  timeTxt.textContent = 'Time: '+parts.time;

  // gps/map
  coordBadge.textContent = `${pr.gps.lat.toFixed(5)}, ${pr.gps.lon.toFixed(5)}`;
  map.setView([pr.gps.lat, pr.gps.lon], 16);
  marker.setLatLng([pr.gps.lat, pr.gps.lon]);

  // list
  gpsList.innerHTML='';
  for(const r of gps){
    const el = document.createElement('div');
    const isHidden = hiddenKeys.has(r.key);
    if (!showHiddenChk.checked && isHidden) continue;
    el.textContent = `${r.lat.toFixed(5)}, ${r.lon.toFixed(5)} [${r.key}]`;
    if (r.key===pr.gps.key) { el.style.fontWeight='bold'; el.style.background='#242424'; }
    if (isHidden) el.classList.add('hidden');
    el.onclick = ()=>{
      const i = visiblePairs.findIndex(x=>x.gps.key===r.key);
      if(i>=0){ idx=i; show(); }
      else if(hiddenKeys.has(r.key)) alert('This pair is hidden. Toggle "Show hidden" to review, or Unhide all.');
    };
    gpsList.appendChild(el);
  }
  updateCounters();

  openPhoto.href = pr.photo.html_url;
  openGPS.href   = pr.gps.html_url;
}

/* ------- Controls ------- */
document.getElementById('prevBtn').onclick = ()=>{ if(idx>0){ idx--; show(); } };
document.getElementById('nextBtn').onclick = ()=>{ if(idx<visiblePairs.length-1){ idx++; show(); } };
document.getElementById('refreshBtn').onclick = reload;

document.getElementById('discardBtn').onclick = ()=>{
  if(!visiblePairs.length) return;
  const pr = visiblePairs[idx];
  hiddenKeys.add(pr.photo.key);
  saveHidden();
  filterVisible(); show();
};

document.getElementById('unhideAllBtn').onclick = ()=>{
  if(!hiddenKeys.size) return;
  if(!confirm('Unhide all hidden items?')) return;
  hiddenKeys.clear(); saveHidden();
  filterVisible(); show();
};

document.getElementById('downloadBtn').onclick = ()=>{
  if(!hiddenKeys.size){ alert('No hidden items.'); return; }
  const lines = [];
  lines.push(`# Discard Log (hidden items)`);
  lines.push(`# Repo: ${OWNER}/${REPO}  |  Branch: ${BRANCH}`);
  lines.push(`# Generated: ${new Date().toISOString()}`);
  lines.push(``);
  for(const key of [...hiddenKeys].sort()){
    const photoURL = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/photos/${encodeURIComponent(key)}.jpg`;
    const gpsURL   = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/GPS/${encodeURIComponent(key)}.txt`;
    lines.push(`- ${key}`);
    lines.push(`  photo: ${photoURL}`);
    lines.push(`  gps:   ${gpsURL}`);
  }
  const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
  const stamp = new Date().toISOString().replace(/[:.]/g,'-');
  saveAs(blob, `discard_log_${stamp}.txt`);
};

// keyboard + theme + hidden toggle
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowRight') document.getElementById('nextBtn').click();
  if(e.key==='ArrowLeft')  document.getElementById('prevBtn').click();
  if(e.key.toLowerCase()==='r') document.getElementById('refreshBtn').click();
});
const themeBtn=document.getElementById('themeBtn');
function setTheme(light){document.body.classList.toggle("light",light);themeBtn.textContent=light?"☀️ Light":"🌙 Dark";localStorage.setItem("theme",light?"light":"dark");}
themeBtn.onclick=()=>setTheme(!document.body.classList.contains("light"));
if(localStorage.getItem("theme")==="light") setTheme(true);
document.getElementById('showHiddenChk').onchange=()=>show();

// boot
reload(); setInterval(reload, POLL_MS);
</script>
</body>
</html>
